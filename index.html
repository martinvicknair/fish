<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>sitesApi</title>
</head>

<body>
  <p>Click the button to find the nearest Kids Sites.</p>
  <button onclick="getLocation()">Try It</button>
  <p id="demo"></p>
  <p id="listings"></p>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript">
    console.log("ready!");

    // these values will come from the html5_geolocation
    var userX = 0;
    var userY = 0;

    var a = document.getElementById("listings");

    // returns list of nearby sites
    function findSites() {

      queryURL = "https://services1.arcgis.com/RLQu0rK7h4kbsBq5/ArcGIS/rest/services/Summer_Meal_Sites_2017/FeatureServer/0/query?geometry=%7Bx%3A" + userX + "%2C+y%3A" + userY +
        "%7D&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelIntersects&distance=2.&units=esriSRUnit_StatuteMile&returnGeodetic=false&outFields=siteName%2CsponsoringOrganization%2C+address%2CcontactPhone%2CstartDate%2C+endDate%2C+daysofOperation%2C+breakfastTime%2C+lunchTime%2C+snackTime%2C+dinnerSupperTime&returnGeometry=true&multipatchOption=xyFootprint&resultRecordCount=99&returnExceededLimitFeatures=true&f=pjson&token=";

      $.ajax({
        url: queryURL,
        method: 'GET'
      }).done(function(response) {
        // console.log(response);
        obj = JSON.parse(response);
        results = obj.features;
        console.log(results);
        for (var i = 0; i < results.length; i++) {
          console.log(results[i].attributes);
          name = results[i].attributes.siteName;
          sponsor = results[i].attributes.sponsoringOrganization;
          address = results[i].attributes.address;
          days = results[i].attributes.daysofOperation;
          contact = formatPhoneNumber(results[i].attributes.contactPhone);
          longLat = results[i].geometry.x + ", " + results[i].geometry.y;

          listing = name + "<br>" + sponsor + "<br>" + address + "<br>" + "Serving on: " + days + "<br>" + "Call " + contact + " for meal times<br>" + longLat + "<br><br>";

          a.innerHTML = a.innerHTML + listing;
        }
      });
    }

    function formatPhoneNumber(s) {
      var s2 = ("" + s).replace(/\D/g, '');
      var m = s2.match(/^(\d{3})(\d{3})(\d{4})$/);
      return (!m) ? null :  m[1] + "-" + m[2] + "-" + m[3];
    }

    //code below from https://www.w3schools.com/html/html5_geolocation.asp
    var g = document.getElementById("demo");

    function getLocation() {
      $('#listings').empty();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        g.innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    function showPosition(position) {
      g.innerHTML = "Latitude: " + position.coords.latitude +
        "<br>Longitude: " + position.coords.longitude;
      userX = position.coords.longitude;
      userY = position.coords.latitude;
      findSites();
    }
  </script>
</body>

</html>
